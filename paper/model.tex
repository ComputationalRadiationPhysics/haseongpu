\section{Model}

This section describes the underlying model and ideas for the $\Phi_{ASE}$
calculation in an active gain medium with planar top and bottom surfaces (see
figure \ref{graphic:samples_reduced}).



\subsection{The crystal mesh} \label{subsec:meshSampling}

In order to distribute the \emph{sample points} on the medium, it is treated as
a horizontal 2-dimensional plane, which can be sampled with a non-uniform
density. This approach allows to increase the spatial resolution in certain
areas of interest. Using Delauny triangulation, these sample points are
connected into a 2D mesh of triangles.

The triangle mesh is extruded in direction of the vertical axis to form a
\emph{slice} of right prisms (figure \ref{graphic:extruded_mesh}). This
slice is then duplicated several times, until the whole medium is divided into
prisms (figure \ref{graphic:samples_reduced}).

\begin{figure}
  \centerline{
    \resizebox{0.5\textwidth} {!} {\includegraphics{graphics/delauny_3.png}}
  }
  \caption{extruded plane of triangles}
  \label{graphic:extruded_mesh}
\end{figure}

\begin{figure}
  \centerline{
    \resizebox{0.5\textwidth} {!} {\includegraphics{graphics/samples_reduced.png}}
  }
  \caption{non-uniform sampling of active gain medium in 2 slices}
  \label{graphic:samples_reduced}
\end{figure}




\subsection{Ray tracing}
\label{subsec:raytracing}

For calculating the amplification of a single ray from a position $r_i$ to a sample
point $r_0$, the ray is traced along its path through the prisms (see figure
\ref{graphic:prism_propagation}). 

\begin{figure}[H]
  \centerline{
    \resizebox{0.5\textwidth} {!} {\includegraphics{./graphics/prism_propagation_3.png}}
  }
  \caption{propagation of a ray through the prism structure}
  \label{graphic:prism_propagation}
\end{figure}

Starting from point $r_i$ inside a prism, there are 5 possible intersection
planes with the ray. One plane for the top and bottom surfaces and one for each
of the 3 horizontal sides. Once the intersection plane is determined (the ray is
intersecting at point $r_x$), the next prism can be calculated based on the
knowledge about the mesh structure:

\begin{description}

  \item[horizontal side]
    the ray will remain in the same slice, but the next prism is based on a
    different triangle. This triangle is a \emph{neighbor} of the previous one.
    The relevant datastructure to determine the neighboring triangle is created
    during the Delauny triangulation in \ref{subsec:meshSampling}.

  \item[top/bottom plane]
    if the ray is intersecting with the top or bottom plane of the prism, the
    next prism will be based on the same triangle as before, but in a different
    slice.

\end{description}

This process is iterated for each prism on the path between $r_i$ and the
desired sample point $r_0$. The intersections (like $r_x$) with prism surfaces
define line segments of a certain length $l_x$. These segments are used for the
gain calculation: For each prism $x$, the contribution to the gain is calculated
as a function of $l_x$:
\[ 
  partial\_gain(x) = 
  e^{N_{tot} \cdot (\beta_x \cdot (\sigma_e + \sigma_a) - \sigma_a)) \cdot l_x}
\]
where $\beta_x$ is the \textbf{TODO: describe beta} beta value in the current
prism.

The gain for the whole ray can then be computed as
\[ 
  gain(\overrightarrow{r_ir_0}) =  
  \frac{\beta_i}{ |\overrightarrow{r_ir_0}|^2} \cdot \prod^npartial\_gain(n) 
\]



\subsection{Reflections}
\label{subsec:reflections}

In order to allow a more detailed simulation, the model is extended to include
reflections on the surface of the medium. The ray is split into multiple
separate sub-rays, each representing one part of the reflection (see figure
\ref{graphic:reflections_2D}: $\overrightarrow{r_im_1}$,
$\overrightarrow{m_1m_2}$, $\overrightarrow{m_2r_0}$).


\begin{figure}
  \centerline{
    \resizebox{0.5\textwidth} {!} {\includegraphics{./graphics/reflections_1.png}}
  }
  \caption{reflections of a ray propagation on the crystal surface}
  \label{graphic:reflections_2D}
\end{figure}


\textbf{TODO: uniform naming for points (not $x_i$ and $m_i$ mixed like they are
now)}
On each of the reflection points, the refractive indices of crystal and
environment are used to determine the maximum angle for a total reflection. This
can now be used to estimate the \emph{initial gain} $g_i$ of a ray that is
reflected at position $x_i$:
\[
  g_i = 
  \begin{cases}
    gain(\overrightarrow{x_{i-1}x_i}) & if \alpha \ge \alpha_{tot}  \\
    gain(\overrightarrow{x_{i-1}x_i}) \cdot reflectivity[x_i] & if \alpha < \alpha_{tot}   
  \end{cases}
\]

The computation of all sub-rays comprises a significant overhead over the more
simplistic model with just a single ray, which necessitates the use of a high
performance algorithm.  The current implementation includes different refractive
indices as well as varying reflectivites for each delauny triangle. However,
only reflections on the upper and lower surface are supported, resulting in a
limited simulation which disregards lateral lasing. 


\subsection{Monte Carlo simulation}
\label{subsec:monteCarlo}

\begin{itemize}

  \item \textit{integral is expressed by formula} \cite[Daniel's Thesis]{ASE2010}

  \item Monte Carlo simulation as a way to calculate the integral for the whole
    crystal.

  \item \textit{formula for the additive Monte Carlo}

\end{itemize}






